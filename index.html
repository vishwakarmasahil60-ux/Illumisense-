<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Illumisense</title>
    
    <!-- APP ICONS -->
    <link rel="icon" type="image/jpeg" href="icon.jpg">
    <link rel="apple-touch-icon" href="icon.jpg">
    <meta name="theme-color" content="#050505">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            user-select: none;
            height: 100dvh; 
        }

        /* --- Ambient Background --- */
        #ambient-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: radial-gradient(circle at 50% 50%, rgba(30,30,35,1) 0%, #000000 100%);
            transition: background 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            filter: blur(60px); opacity: 0.6;
        }

        /* --- UI Glassmorphism --- */
        .glass {
            background: rgba(25, 25, 30, 0.65);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-panel {
            background: rgba(15, 15, 18, 0.96);
            backdrop-filter: blur(24px);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.7);
        }

        /* --- ANIMATIONS --- */
        .room-card {
            transition: 
                background-color 0.5s ease,
                border-color 0.5s ease,
                transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.5s ease;
        }
        .room-card:active { transform: scale(0.96); }

        /* Milky White Faded Halo */
        @keyframes milky-halo {
            0% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.3), 0 0 30px var(--glow-color-dim); border-color: rgba(255, 255, 255, 0.3); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 255, 0.6), 0 0 50px var(--glow-color); border-color: rgba(255, 255, 255, 0.5); }
            100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.3), 0 0 30px var(--glow-color-dim); border-color: rgba(255, 255, 255, 0.3); }
        }
        
        .animate-glow { animation: milky-halo 3s ease-in-out infinite; z-index: 10; }
        .toggle-switch { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.3s ease; }
        .room-icon, .room-text { transition: all 0.3s ease; }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .listening-ring {
            position: absolute; border-radius: 50%; border: 2px solid #3B82F6;
            width: 100%; height: 100%;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            pointer-events: none;
        }

        /* --- COLOR WHEEL STYLES --- */
        #color-wheel-container {
            touch-action: none;
            position: relative;
            width: 260px; height: 260px;
            margin: 0 auto;
        }
        
        #color-wheel-bg {
            width: 100%; height: 100%;
            border-radius: 50%;
            background: conic-gradient(red, yellow, lime, cyan, blue, magenta, red);
            -webkit-mask: radial-gradient(transparent 55%, black 55%);
            mask: radial-gradient(transparent 55%, black 55%);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        #wheel-knob {
            position: absolute; top: 0; left: 50%;
            width: 36px; height: 36px;
            background: white; border: 3px solid rgba(255,255,255,0.8);
            border-radius: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            cursor: grab; pointer-events: none; z-index: 20;
        }

        #center-color-preview {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 110px; height: 110px; border-radius: 50%;
            background: #333;
            box-shadow: inset 0 4px 20px rgba(0,0,0,0.6), 0 0 30px var(--glow-color-dim);
            transition: background-color 0.1s linear;
            display: flex; align-items: center; justify-content: center; z-index: 5;
        }

        /* --- Sliders & Others --- */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
            background: #ffffff; cursor: pointer; margin-top: -12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4); border: 2px solid rgba(0,0,0,0.1);
            transform: scale(1); transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; border-radius: 2px; }
        .temp-gradient { background: linear-gradient(to right, #FF8C00, #FFD6AA, #FFFFFF, #D4EBFF, #3B82F6); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sortable-ghost { opacity: 0.4; transform: scale(0.95); }
        .sortable-drag { cursor: grabbing; opacity: 1; transform: scale(1.05) rotate(2deg); box-shadow: 0 20px 40px rgba(0,0,0,0.5); z-index: 50; }
        @keyframes slideUpFade { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        .tip-card { animation: slideUpFade 0.6s ease-out forwards; }
    </style>
</head>
<body class="flex flex-col items-center justify-center bg-black selection:bg-blue-500 selection:text-white">

    <div id="ambient-bg"></div>

    <div class="w-full h-full max-w-md relative flex flex-col shadow-2xl overflow-hidden z-10 bg-transparent">
        
        <!-- Header -->
        <header class="px-6 pt-12 pb-4 flex justify-between items-center z-20">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">Illumisense</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-xs text-gray-400">System Online</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleVoiceControl()" id="voice-btn" class="w-10 h-10 rounded-full glass flex items-center justify-center text-white relative transition-all active:scale-95 border border-white/10">
                    <i class="ph-bold ph-microphone"></i>
                    <div id="voice-ring" class="hidden listening-ring"></div>
                </button>
                <div class="w-10 h-10 rounded-full glass flex items-center justify-center border border-white/10 overflow-hidden">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full">
                </div>
            </div>
        </header>

        <!-- VIEW: HOME (Increased padding-bottom to clear nav bar) -->
        <main id="view-home" class="flex-1 overflow-y-auto no-scrollbar px-4 pb-32 transition-opacity duration-300">
            <!-- Scenes -->
            <div class="mb-6">
                <div class="flex justify-between items-end px-2 mb-3">
                    <h2 class="text-sm font-semibold text-gray-400">Scenes</h2>
                    <button onclick="togglePartyMode()" id="party-btn" class="text-xs px-3 py-1 rounded-full border border-purple-500/30 text-purple-400 flex items-center gap-1 active:bg-purple-500/20 transition-all">
                        <i class="ph-fill ph-speaker-high"></i> Party
                    </button>
                </div>
                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-2 snap-x">
                    
                    <!-- Scenes List -->
                     <button onclick="applyGlobalScene('night')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-900 to-slate-800 text-indigo-300 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-moon-stars"></i></div>
                        <span class="text-xs font-medium">Night</span>
                    </button>
                    <button onclick="applyGlobalScene('relax')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-400/20 to-red-500/20 text-orange-400 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-coffee"></i></div>
                        <span class="text-xs font-medium">Relax</span>
                    </button>
                     <button onclick="applyGlobalScene('focus')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400/20 to-cyan-500/20 text-blue-400 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-book-open"></i></div>
                        <span class="text-xs font-medium">Focus</span>
                    </button>
                     <button onclick="applyGlobalScene('movie')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400/20 to-indigo-500/20 text-purple-400 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-film-strip"></i></div>
                        <span class="text-xs font-medium">Cinema</span>
                    </button>

                    <!-- Moods -->
                    <button onclick="applyGlobalScene('ocean')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform border-l-2 border-cyan-500/50">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-900 to-blue-900 text-cyan-300 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-waves"></i></div>
                        <span class="text-xs font-medium">Ocean</span>
                    </button>
                    <button onclick="applyGlobalScene('forest')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform border-l-2 border-green-500/50">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-900 to-emerald-900 text-green-300 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-tree"></i></div>
                        <span class="text-xs font-medium">Forest</span>
                    </button>
                     <button onclick="applyGlobalScene('sunset')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform border-l-2 border-orange-500/50">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-900 to-red-900 text-orange-300 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-sun-horizon"></i></div>
                        <span class="text-xs font-medium">Sunset</span>
                    </button>
                    <button onclick="applyGlobalScene('romance')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform border-l-2 border-pink-500/50">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-900 to-purple-900 text-pink-300 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-heart"></i></div>
                        <span class="text-xs font-medium">Romance</span>
                    </button>

                    <button onclick="applyGlobalScene('off')" class="snap-start flex-shrink-0 flex flex-col items-center gap-2 p-4 rounded-2xl glass w-22 active:scale-95 transition-transform">
                        <div class="w-12 h-12 rounded-full bg-white/5 text-gray-400 flex items-center justify-center text-2xl shadow-inner border border-white/5"><i class="ph-fill ph-power"></i></div>
                        <span class="text-xs font-medium">All Off</span>
                    </button>
                </div>
            </div>

            <!-- Rooms -->
            <div class="px-2">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-semibold text-gray-400">My Rooms</h2>
                    <span class="text-[10px] text-gray-600 bg-gray-900 px-2 py-1 rounded border border-gray-800">Long press to reorder</span>
                </div>
                <div id="rooms-container" class="grid grid-cols-2 gap-4 pb-4 relative px-1">
                    <!-- Cards will be injected here by JS -->
                </div>
            </div>
        </main>

        <!-- VIEW: ENERGY -->
        <main id="view-energy" class="flex-1 overflow-y-auto no-scrollbar px-6 pb-32 hidden transition-opacity duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Energy Insights</h2>
                <div class="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full">
                    <i id="eco-icon" class="ph-fill ph-leaf text-green-400"></i>
                    <span id="eco-score" class="text-xs font-semibold text-green-400">Eco Friendly</span>
                </div>
            </div>
            
            <div class="glass rounded-3xl p-6 mb-6 relative overflow-hidden shadow-lg">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-gradient-to-br from-green-500/30 to-emerald-500/10 rounded-full blur-3xl"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-400 font-medium">Real-time Load</p>
                            <div class="flex items-end gap-2 mt-1">
                                <h3 class="text-4xl font-extrabold text-white tracking-tight" id="current-watts">0</h3>
                                <span class="text-lg text-green-400 font-medium mb-1">W</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400 font-medium">Est. Cost</p>
                            <p class="text-xl font-semibold text-white mt-1">₹<span id="hourly-cost">0.00</span><span class="text-xs font-normal text-gray-500">/hr</span></p>
                        </div>
                    </div>
                    <div class="mt-5 pt-4 border-t border-white/10">
                        <div class="flex justify-between text-xs text-gray-300 mb-2 font-medium">
                            <span>Monthly Budget (₹2,500)</span>
                            <span id="budget-percent">32%</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-2.5 overflow-hidden shadow-inner">
                            <div class="bg-gradient-to-r from-green-400 via-emerald-500 to-blue-500 h-2.5 rounded-full transition-all duration-1000" style="width: 32%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass rounded-3xl p-4 col-span-1 flex flex-col justify-between shadow-md hover:bg-white/5 transition-colors">
                    <h3 class="text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wider">Usage by Room</h3>
                    <div class="relative h-24 w-24 mx-auto my-1">
                        <canvas id="donutChart"></canvas>
                    </div>
                    <div class="text-center mt-2">
                        <span class="text-[10px] text-gray-500 font-medium">Living Room High</span>
                    </div>
                </div>
                <div class="glass rounded-3xl p-4 col-span-1 flex flex-col justify-center gap-4 shadow-md">
                    <div class="text-center">
                         <i class="ph-duotone ph-lightning text-3xl text-yellow-400 mb-1 drop-shadow-lg"></i>
                         <p class="text-xs text-gray-400 font-medium">Grid Status</p>
                         <p class="font-bold text-sm text-green-400">Stable</p>
                    </div>
                     <div class="text-center pt-3 border-t border-white/10">
                         <p class="text-xs text-gray-400 font-medium">Active Lights</p>
                         <p class="font-bold text-xl text-white tracking-wide" id="active-lights-count">0</p>
                    </div>
                </div>
            </div>

            <div class="glass rounded-3xl p-5 mb-6 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold px-1">Weekly Trend</h3>
                    <span class="text-[10px] bg-white/5 px-2 py-1 rounded text-gray-400">kWh</span>
                </div>
                <canvas id="energyChart" height="160"></canvas>
            </div>

            <div class="tip-card glass rounded-2xl p-4 border-l-4 border-green-500 bg-gradient-to-r from-green-900/20 to-transparent mb-6">
                <div class="flex items-start gap-3">
                    <div class="bg-green-500/20 p-2 rounded-full text-green-400 shrink-0">
                        <i class="ph-fill ph-lightbulb-filament text-xl"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-green-100 mb-1">Energy Saving Tip</h4>
                        <p class="text-xs text-gray-300 leading-relaxed">
                            Did you know? Dimming your lights to <span class="text-white font-bold">20% brightness</span> creates a cozy vibe and saves over <span class="text-white font-bold">60% energy</span>.
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navigation (KEY FIX: Fixed position + Padding for bottom bar) -->
        <nav class="fixed bottom-0 w-full glass-panel h-[100px] flex justify-around items-start pt-4 z-30 rounded-t-[2rem] border-t border-white/5 pb-6">
            <button onclick="switchView('home')" id="nav-home" class="flex flex-col items-center gap-1 p-2 w-16 text-blue-400 transition-colors"><i class="ph-fill ph-house text-2xl"></i><span class="text-[10px] font-medium">Home</span></button>
            <button onclick="switchView('energy')" id="nav-energy" class="flex flex-col items-center gap-1 p-2 w-16 text-gray-500 hover:text-white transition-colors"><i class="ph-bold ph-lightning text-2xl"></i><span class="text-[10px] font-medium">Energy</span></button>
            <button class="flex flex-col items-center gap-1 p-2 w-16 text-gray-500 hover:text-white transition-colors opacity-50 cursor-not-allowed"><i class="ph-bold ph-gear text-2xl"></i><span class="text-[10px] font-medium">Settings</span></button>
        </nav>

        <!-- MODAL -->
        <div id="room-modal" class="absolute inset-0 z-50 translate-y-full transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) flex flex-col">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-500" onclick="closeModal()"></div>
            
            <div class="absolute bottom-0 w-full h-[92%] glass-panel rounded-t-[2.5rem] flex flex-col p-6 shadow-2xl border-t border-white/10 overflow-y-auto">
                <div class="w-12 h-1.5 bg-gray-600/50 rounded-full mx-auto mb-6"></div>

                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 id="modal-room-name" class="text-3xl font-bold tracking-tight">Room</h2>
                        <p id="modal-room-status" class="text-sm text-gray-400 mt-1">Status</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="toggleSleepTimer()" id="timer-btn" class="w-14 h-14 rounded-full bg-white/5 border border-white/5 flex items-center justify-center text-xl text-gray-400 active:scale-90 transition-all">
                            <i class="ph-bold ph-timer"></i>
                        </button>
                        <button onclick="toggleRoomPowerFromModal()" id="modal-power-btn" class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center text-2xl transition-all active:scale-90 shadow-lg border border-white/5">
                            <i class="ph-fill ph-power"></i>
                        </button>
                    </div>
                </div>

                <div class="flex-1 flex flex-col items-center justify-start gap-6">
                    <!-- Interactive Color Wheel -->
                    <div id="color-wheel-container" class="group">
                        <div id="color-wheel-bg"></div>
                        <div id="wheel-knob"></div>
                        <div id="center-color-preview"><i class="ph-fill ph-lightbulb text-3xl text-white/80"></i></div>
                    </div>

                    <!-- Color Palette Swatches -->
                    <div class="flex gap-3 justify-center w-full pt-2">
                        <button onclick="setWheelColorFromHex('#ffffff')" class="w-8 h-8 rounded-full bg-white border border-white/20 shadow-sm active:scale-90 transition-transform"></button>
                        <button onclick="setWheelColorFromHex('#fbbf24')" class="w-8 h-8 rounded-full bg-amber-400 border border-white/20 shadow-sm active:scale-90 transition-transform"></button>
                        <button onclick="setWheelColorFromHex('#f87171')" class="w-8 h-8 rounded-full bg-red-400 border border-white/20 shadow-sm active:scale-90 transition-transform"></button>
                        <button onclick="setWheelColorFromHex('#60a5fa')" class="w-8 h-8 rounded-full bg-blue-400 border border-white/20 shadow-sm active:scale-90 transition-transform"></button>
                        <button onclick="setWheelColorFromHex('#a78bfa')" class="w-8 h-8 rounded-full bg-purple-400 border border-white/20 shadow-sm active:scale-90 transition-transform"></button>
                    </div>

                    <div class="w-full space-y-6 mt-4">
                        <div>
                            <div class="flex justify-between text-xs text-gray-400 mb-2 font-medium"><span>Brightness</span><span id="brightness-value">100%</span></div>
                            <div class="relative h-10 flex items-center">
                                <i class="ph-fill ph-sun-dim absolute left-3 z-10 text-black/50"></i>
                                <input type="range" min="0" max="100" id="brightness-slider" oninput="handleBrightnessChange(this.value)" class="w-full z-0">
                                <i class="ph-fill ph-sun absolute right-3 z-10 text-black/50"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-400 mb-2 font-medium"><span>Temperature</span><span id="temp-value">Warm</span></div>
                            <div class="relative h-2 rounded-full overflow-hidden w-full">
                                <div class="absolute inset-0 temp-gradient"></div>
                                <input type="range" min="2000" max="6500" step="100" id="temp-slider" oninput="handleTempChange(this.value)" class="absolute inset-0 opacity-0 cursor-pointer z-20 h-full w-full">
                                <div id="temp-thumb" class="absolute top-0 h-full w-1 bg-white shadow-md pointer-events-none" style="left: 50%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW SCIENTIFIC MOODS SECTION (Modal) -->
                    <div class="w-full mt-2">
                         <h3 class="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wider">Moods</h3>
                         <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                             <!-- Ocean -->
                             <button onclick="triggerEffect('ocean')" class="flex-shrink-0 flex items-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-br from-cyan-900/40 to-blue-900/40 border border-white/5 text-xs font-medium text-cyan-200 active:scale-95 transition-transform">
                                 <i class="ph-fill ph-waves text-cyan-400 text-lg"></i> <div><span class="block font-bold">Ocean</span><span class="text-[10px] opacity-70 font-normal">Calm</span></div>
                             </button>
                             <!-- Forest -->
                             <button onclick="triggerEffect('forest')" class="flex-shrink-0 flex items-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-br from-green-900/40 to-emerald-900/40 border border-white/5 text-xs font-medium text-green-200 active:scale-95 transition-transform">
                                 <i class="ph-fill ph-tree text-green-400 text-lg"></i> <div><span class="block font-bold">Forest</span><span class="text-[10px] opacity-70 font-normal">Restore</span></div>
                             </button>
                             <!-- Sunset -->
                             <button onclick="triggerEffect('sunset')" class="flex-shrink-0 flex items-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-br from-orange-900/40 to-red-900/40 border border-white/5 text-xs font-medium text-orange-200 active:scale-95 transition-transform">
                                 <i class="ph-fill ph-sun-horizon text-orange-400 text-lg"></i> <div><span class="block font-bold">Sunset</span><span class="text-[10px] opacity-70 font-normal">Sleep</span></div>
                             </button>
                             <!-- Romance -->
                             <button onclick="triggerEffect('romance')" class="flex-shrink-0 flex items-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-br from-pink-900/40 to-purple-900/40 border border-white/5 text-xs font-medium text-pink-200 active:scale-95 transition-transform">
                                 <i class="ph-fill ph-heart text-pink-400 text-lg"></i> <div><span class="block font-bold">Romance</span><span class="text-[10px] opacity-70 font-normal">Ambiance</span></div>
                             </button>
                             <!-- Candle -->
                             <button onclick="triggerEffect('candle')" class="flex-shrink-0 flex items-center gap-2 px-4 py-3 rounded-xl bg-white/5 border border-white/5 text-xs font-medium text-gray-300 active:scale-95 transition-transform">
                                 <i class="ph-fill ph-fire text-orange-400 text-lg"></i> Candle
                             </button>
                             <!-- Disco -->
                             <button onclick="triggerEffect('disco')" class="flex-shrink-0 flex items-center gap-2 px-4 py-3 rounded-xl bg-white/5 border border-white/5 text-xs font-medium text-gray-300 active:scale-95 transition-transform">
                                 <i class="ph-fill ph-sparkle text-purple-400 text-lg"></i> Disco
                             </button>
                         </div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-white/5">
                    <div class="flex justify-between items-center mb-3"><h3 class="text-sm font-semibold text-gray-300">Automation</h3><button class="text-blue-400 text-xs font-bold">+ Add</button></div>
                    <div class="bg-white/5 rounded-xl p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-orange-500/20 text-orange-400 flex items-center justify-center"><i class="ph-fill ph-alarm"></i></div>
                            <div><div class="text-sm font-medium">Wake Up</div><div class="text-xs text-gray-500">7:00 AM • Fade in</div></div>
                        </div>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" checked class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 checked:left-5 checked:border-green-400"/>
                            <label class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-700 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let currentRoomId = null;
        let roomsData = {};
        let partyModeInterval = null;
        let effectInterval = null;
        let energyChartInstance = null;
        let donutChartInstance = null;
        let brightnessTimeout; 
        let colorWheelActive = false;

        // --- DATA VERSIONING (For Reset) ---
        const DATA_VERSION = 3; // Increment to force reset for new users/updates

        // --- DEFAULT LOCAL DATA (For standalone use) ---
        const DEFAULT_ROOMS = {
            'living': { id: 'living', name: 'Living Room', icon: 'ph-armchair', isOn: true, brightness: 80, color: '#FF9500', order: 0 },
            'kitchen': { id: 'kitchen', name: 'Kitchen', icon: 'ph-cooking-pot', isOn: true, brightness: 100, color: '#FFFFFF', order: 1 },
            'bedroom': { id: 'bedroom', name: 'Bedroom', icon: 'ph-bed', isOn: false, brightness: 40, color: '#8B5CF6', order: 2 },
            'office': { id: 'office', name: 'Office', icon: 'ph-desktop', isOn: false, brightness: 60, color: '#3B82F6', order: 3 },
            'hallway': { id: 'hallway', name: 'Hallway', icon: 'ph-door', isOn: false, brightness: 30, color: '#FCD34D', order: 4 },
            'garden': { id: 'garden', name: 'Garden', icon: 'ph-potted-plant', isOn: false, brightness: 100, color: '#10B981', order: 5 }
        };

        // Try to load from localStorage or use defaults
        try {
            const currentVersion = parseInt(localStorage.getItem('illumisense_version') || '0');
            if (currentVersion < DATA_VERSION) {
                // FORCE RESET for update
                roomsData = JSON.parse(JSON.stringify(DEFAULT_ROOMS));
                localStorage.setItem('illumisense_version', DATA_VERSION);
                saveLocalData();
                console.log("App updated: Data reset to defaults.");
            } else {
                const saved = localStorage.getItem('illumisense_rooms');
                if (saved) roomsData = JSON.parse(saved);
                else roomsData = JSON.parse(JSON.stringify(DEFAULT_ROOMS));
            }
        } catch(e) {
            roomsData = JSON.parse(JSON.stringify(DEFAULT_ROOMS));
        }

        function saveLocalData() {
            localStorage.setItem('illumisense_rooms', JSON.stringify(roomsData));
            renderApp();
        }

        // --- INITIALIZATION ---
        function initApp() {
            initColorWheel();
            renderApp();
            
            // Init Charts on load
            updateEnergyStats();
            initSortable(document.getElementById('rooms-container'));
        }

        function renderApp() {
            const container = document.getElementById('rooms-container');
            // Only clear if first run or specific need, DOM Diffing for performance
            if (container.children.length === 0) {
                // Initial Render
                const sorted = Object.values(roomsData).sort((a, b) => a.order - b.order);
                sorted.forEach(room => {
                    container.appendChild(createRoomCard(room));
                });
            } else {
                // Update existing
                Object.values(roomsData).forEach(room => {
                    const el = container.querySelector(`[data-id="${room.id}"]`);
                    if (el) updateRoomCardDOM(el, room);
                });
            }
            
            updateAmbientBackground();
            updateEnergyStats();
            if (currentRoomId && roomsData[currentRoomId]) updateModalUI(roomsData[currentRoomId]);
        }

        // --- CORE LOGIC ---

        function updateRoomCardDOM(div, room) {
            const isLight = isColorLight(room.color);
            const textColor = (room.isOn && isLight) ? 'text-black' : 'text-white';
            const subTextColor = (room.isOn && isLight) ? 'text-black/60' : 'text-gray-400';
            const iconBg = (room.isOn && isLight) ? 'bg-black/10' : 'bg-white/10';
            
            const iconContainer = div.querySelector('.room-icon-container');
            const toggleSwitch = div.querySelector('.toggle-switch');
            const toggleBtn = div.querySelector('.toggle-btn');
            const title = div.querySelector('h3');
            const status = div.querySelector('p');
            const bgGradient = div.querySelector('.bg-gradient-overlay');

            if (room.isOn) {
                div.style.setProperty('--glow-color', room.color);
                div.style.setProperty('--glow-color-dim', `${room.color}80`);
                div.style.backgroundColor = room.color;
                div.style.borderColor = 'rgba(255,255,255,0.2)';
                div.classList.add('animate-glow');
                div.classList.remove('glass');
                bgGradient.classList.remove('opacity-0'); bgGradient.classList.add('opacity-100');
                toggleBtn.className = "toggle-btn w-12 h-7 rounded-full p-1 transition-colors duration-300 bg-white shadow-lg";
                toggleSwitch.className = "w-5 h-5 rounded-full shadow-md transform toggle-switch translate-x-5 bg-current text-black";
            } else {
                div.style.backgroundColor = 'rgba(30, 30, 35, 0.6)';
                div.style.borderColor = 'rgba(255,255,255,0.08)';
                div.style.boxShadow = 'none';
                div.classList.remove('animate-glow');
                div.classList.add('glass');
                bgGradient.classList.remove('opacity-100'); bgGradient.classList.add('opacity-0');
                toggleBtn.className = "toggle-btn w-12 h-7 rounded-full p-1 transition-colors duration-300 bg-gray-700 shadow-lg";
                toggleSwitch.className = "w-5 h-5 rounded-full shadow-md transform toggle-switch translate-x-0 bg-gray-400";
            }
            iconContainer.className = `room-icon-container w-10 h-10 rounded-full ${iconBg} backdrop-blur-md flex items-center justify-center text-xl transition-colors room-icon`;
            title.className = `font-bold text-lg leading-tight mb-1 truncate ${textColor} room-text`;
            status.className = `text-xs font-medium ${subTextColor} room-text`;
            status.textContent = room.isOn ? `${room.brightness}%` : 'Off';
            div.onclick = (e) => { if (!e.target.closest('.toggle-btn')) { openModal(room.id); triggerHaptic(); } };
            toggleBtn.onclick = (e) => { e.stopPropagation(); toggleRoom(room.id, !room.isOn); };
        }

        function createRoomCard(room) {
            const div = document.createElement('div');
            div.className = `room-card relative rounded-3xl p-4 h-44 flex flex-col justify-between cursor-pointer select-none group overflow-hidden`;
            div.setAttribute('data-id', room.id);
            div.innerHTML = `
                <div class="bg-gradient-overlay absolute inset-0 bg-gradient-to-br from-white/20 to-transparent transition-opacity duration-500 pointer-events-none"></div>
                <div class="relative z-10 flex justify-between items-start">
                    <div class="room-icon-container w-10 h-10 rounded-full flex items-center justify-center text-xl"><i class="ph-fill ${room.icon}"></i></div>
                    <button class="toggle-btn w-12 h-7 rounded-full p-1 shadow-lg"><div class="toggle-switch w-5 h-5 rounded-full shadow-md"></div></button>
                </div>
                <div class="relative z-10 mt-auto"><h3>${room.name}</h3><p>Off</p></div>
            `;
            updateRoomCardDOM(div, room);
            return div;
        }

        // --- ACTIONS ---

        window.toggleRoom = (id, state) => {
            triggerHaptic();
            if (roomsData[id]) {
                roomsData[id].isOn = state;
                saveLocalData();
            }
        };

        window.updateRoomColorThrottled = (hex) => {
            clearTimeout(brightnessTimeout);
            brightnessTimeout = setTimeout(() => { 
                if(currentRoomId && roomsData[currentRoomId]) {
                    roomsData[currentRoomId].color = hex;
                    roomsData[currentRoomId].isOn = true;
                    saveLocalData();
                }
            }, 50);
        };

        window.handleBrightnessChange = (val) => {
            const value = parseInt(val);
            const slider = document.getElementById('brightness-slider');
            if(currentRoomId && roomsData[currentRoomId]) {
                 const room = roomsData[currentRoomId];
                 slider.style.background = `linear-gradient(to right, ${room.color} 0%, ${room.color} ${value}%, rgba(255,255,255,0.1) ${value}%, rgba(255,255,255,0.1) 100%)`;
                 document.getElementById('brightness-value').textContent = `${value}%`;
                 
                 clearTimeout(brightnessTimeout);
                 brightnessTimeout = setTimeout(() => { 
                    roomsData[currentRoomId].brightness = value;
                    roomsData[currentRoomId].isOn = true;
                    saveLocalData();
                 }, 250);
            }
        };
        
        window.handleTempChange = (kelvin) => {
            const percent = ((kelvin - 2000) / (4500)) * 100;
            document.getElementById('temp-thumb').style.left = `${percent}%`;
            const hex = kelvinToHex(kelvin);
            setWheelColorFromHex(hex);
        };

        window.applyGlobalScene = (type) => {
            triggerHaptic();
            Object.keys(roomsData).forEach(id => {
                if (type === 'night') { roomsData[id].color = '#4338ca'; roomsData[id].brightness = 15; roomsData[id].isOn = true; }
                else if (type === 'relax') { roomsData[id].color = '#FFB74D'; roomsData[id].brightness = 40; roomsData[id].isOn = true; }
                else if (type === 'focus') { roomsData[id].color = '#E1F5FE'; roomsData[id].brightness = 100; roomsData[id].isOn = true; }
                else if (type === 'movie') { roomsData[id].color = '#311B92'; roomsData[id].brightness = 20; roomsData[id].isOn = true; }
                else if (type === 'ocean') { roomsData[id].color = '#00FFFF'; roomsData[id].brightness = 60; roomsData[id].isOn = true; } 
                else if (type === 'forest') { roomsData[id].color = '#228B22'; roomsData[id].brightness = 50; roomsData[id].isOn = true; } 
                else if (type === 'sunset') { roomsData[id].color = '#FF4500'; roomsData[id].brightness = 40; roomsData[id].isOn = true; } 
                else if (type === 'romance') { roomsData[id].color = '#FF00FF'; roomsData[id].brightness = 30; roomsData[id].isOn = true; }
                else if (type === 'off') { roomsData[id].isOn = false; }
            });
            saveLocalData();
        };

        window.togglePartyMode = () => {
            const btn = document.getElementById('party-btn'); triggerHaptic();
            if (partyModeInterval) {
                clearInterval(partyModeInterval); partyModeInterval = null;
                btn.classList.remove('bg-purple-500', 'text-white'); btn.classList.add('text-purple-400');
            } else {
                btn.classList.add('bg-purple-500', 'text-white'); btn.classList.remove('text-purple-400');
                partyModeInterval = setInterval(() => {
                    const colors = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'];
                    Object.keys(roomsData).forEach(id => { 
                        if(roomsData[id].isOn) roomsData[id].color = colors[Math.floor(Math.random() * colors.length)]; 
                    });
                    saveLocalData(); // Triggers render
                }, 800);
            }
        };
        
        window.triggerEffect = (type) => {
            triggerHaptic();
            clearInterval(effectInterval);
            if (!currentRoomId && ['ocean', 'forest', 'sunset', 'romance'].includes(type)) {
                window.applyGlobalScene(type);
                return;
            }
            if(!currentRoomId) return;
            
            const animate = (cb, time) => {
                effectInterval = setInterval(() => {
                    cb();
                    saveLocalData();
                }, time);
            };

            if(type === 'candle') animate(() => {
                 roomsData[currentRoomId].brightness = Math.floor(Math.random() * 20) + 70; 
                 roomsData[currentRoomId].color = Math.random() > 0.5 ? '#FF9500' : '#FFA500'; 
            }, 300);
            else if (type === 'disco') animate(() => {
                const colors = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'];
                roomsData[currentRoomId].color = colors[Math.floor(Math.random() * colors.length)];
            }, 600);
            else if (type === 'read') { roomsData[currentRoomId].color = '#FFD6AA'; roomsData[currentRoomId].brightness = 80; saveLocalData(); }
            else if (type === 'ocean') { let p = 0; animate(() => { p=!p; roomsData[currentRoomId].color = p ? '#0077BE':'#00FFFF'; }, 4000); }
            else if (type === 'forest') { let p = 0; animate(() => { p=!p; roomsData[currentRoomId].color = p ? '#228B22':'#32CD32'; }, 5000); }
            else if (type === 'sunset') { let p = 0; animate(() => { p=!p; roomsData[currentRoomId].color = p ? '#FF4500':'#8B0000'; }, 6000); }
            else if (type === 'romance') { roomsData[currentRoomId].color = '#FF00FF'; saveLocalData(); }
        };


        // --- UTILS ---

        function updateAmbientBackground() {
            const active = Object.values(roomsData).filter(r => r.isOn).map(r => r.color);
            const bg = document.getElementById('ambient-bg');
            if (active.length === 0) bg.style.background = `radial-gradient(circle at 50% 50%, #1a1a20 0%, #000000 100%)`;
            else {
                const c1 = active[0], c2 = active[1] || c1, c3 = active[2] || c1;
                bg.style.background = `radial-gradient(circle at 20% 20%, ${c1} 0%, transparent 50%), radial-gradient(circle at 80% 80%, ${c2} 0%, transparent 50%), radial-gradient(circle at 50% 50%, ${c3} 0%, #050505 100%)`;
            }
        }

        function updateEnergyStats() {
            let count = 0, watts = 0;
            let labels = [], data = [], colors = [];
            Object.values(roomsData).forEach(room => {
                if(room.isOn) {
                    const w = Math.round(room.brightness * 0.15);
                    count++; watts += w;
                    labels.push(room.name); data.push(w); colors.push(room.color);
                }
            });

            document.getElementById('current-watts').textContent = watts;
            document.getElementById('active-lights-count').textContent = count;
            const cost = (watts / 1000) * 8.0;
            document.getElementById('hourly-cost').textContent = cost.toFixed(2);
            
            // Charts
            const ctxLine = document.getElementById('energyChart').getContext('2d');
            if(!energyChartInstance) {
                const gradient = ctxLine.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, 'rgba(74, 222, 128, 0.5)'); gradient.addColorStop(1, 'rgba(74, 222, 128, 0)');
                energyChartInstance = new Chart(ctxLine, {
                    type: 'line', 
                    data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'kWh Usage', data: [12, 19, 15, 17, 22, 28, 24], borderColor: '#4ade80', backgroundColor: gradient, borderWidth: 2, tension: 0.4, pointRadius: 0, fill: true }] },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: true, grid: { display: false }, ticks: { color: '#666', font: {size: 10} } }, y: { display: false } } }
                });
            }
            const ctxDonut = document.getElementById('donutChart').getContext('2d');
            if(donutChartInstance) {
                donutChartInstance.data.labels = labels;
                donutChartInstance.data.datasets[0].data = data;
                donutChartInstance.data.datasets[0].backgroundColor = colors;
                donutChartInstance.update();
            } else {
                donutChartInstance = new Chart(ctxDonut, {
                    type: 'doughnut',
                    data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
                    options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
                });
            }
        }

        // Color Wheel Logic
        const wheelContainer = document.getElementById('color-wheel-container');
        const wheelKnob = document.getElementById('wheel-knob');
        const centerPreview = document.getElementById('center-color-preview');
        
        function initColorWheel() {
            wheelContainer.addEventListener('pointerdown', handleWheelStart);
            window.addEventListener('pointermove', handleWheelMove);
            window.addEventListener('pointerup', handleWheelEnd);
        }
        function handleWheelStart(e) { colorWheelActive = true; handleWheelMove(e); }
        function handleWheelMove(e) {
            if (!colorWheelActive) return;
            e.preventDefault();
            const rect = wheelContainer.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const dx = e.clientX - centerX;
            const dy = e.clientY - centerY;
            let angle = Math.atan2(dy, dx) * (180 / Math.PI);
            if (angle < 0) angle += 360; 
            const hue = (angle + 90) % 360;
            const radius = (rect.width / 2) - 20; 
            const knobX = (Math.cos(angle * Math.PI / 180) * radius) + (rect.width / 2);
            const knobY = (Math.sin(angle * Math.PI / 180) * radius) + (rect.height / 2);
            wheelKnob.style.left = `${knobX}px`;
            wheelKnob.style.top = `${knobY}px`;
            const color = `hsl(${hue}, 100%, 50%)`;
            centerPreview.style.backgroundColor = color;
            updateRoomColorThrottled(hslToHex(hue, 100, 50));
        }
        function handleWheelEnd() { if (colorWheelActive) { colorWheelActive = false; triggerHaptic(); } }
        window.setWheelColorFromHex = (hex) => { triggerHaptic(); centerPreview.style.backgroundColor = hex; updateRoomColorThrottled(hex); }

        // Helpers
        window.openModal = (roomId) => { currentRoomId = roomId; updateModalUI(roomsData[roomId]); document.getElementById('room-modal').classList.remove('translate-y-full'); };
        window.closeModal = () => { document.getElementById('room-modal').classList.add('translate-y-full'); clearInterval(effectInterval); setTimeout(() => { currentRoomId = null; }, 500); };
        
        function updateModalUI(room) {
            document.getElementById('modal-room-name').textContent = room.name;
            document.getElementById('modal-room-status').textContent = room.isOn ? `On • ${room.brightness}%` : 'Off';
            const slider = document.getElementById('brightness-slider');
            slider.value = room.brightness;
            document.getElementById('brightness-value').textContent = `${room.brightness}%`;
            slider.style.background = `linear-gradient(to right, ${room.color} 0%, ${room.color} ${room.brightness}%, rgba(255,255,255,0.1) ${room.brightness}%, rgba(255,255,255,0.1) 100%)`;
            if(!colorWheelActive) document.getElementById('center-color-preview').style.backgroundColor = room.color;
        }
        
        window.switchView = (viewId) => {
            triggerHaptic(); 
            if (viewId === 'home') { 
                document.getElementById('view-home').classList.remove('hidden'); 
                document.getElementById('view-energy').classList.add('hidden'); 
                document.getElementById('nav-home').classList.replace('text-gray-500', 'text-blue-400');
                document.getElementById('nav-energy').classList.replace('text-green-400', 'text-gray-500');
            } else { 
                document.getElementById('view-home').classList.add('hidden'); 
                document.getElementById('view-energy').classList.remove('hidden');
                document.getElementById('nav-home').classList.replace('text-blue-400', 'text-gray-500');
                document.getElementById('nav-energy').classList.replace('text-gray-500', 'text-green-400');
            }
        };

        // --- (SMARTER VOICE CONTROL) ---
        window.toggleVoiceControl = () => {
            if (!('webkitSpeechRecognition' in window)) { 
                // A soft alert for non-compatible browsers
                alert("Voice control requires a modern browser (Chrome/Edge)."); 
                return; 
            }
            const btn = document.getElementById('voice-btn'), ring = document.getElementById('voice-ring');
            triggerHaptic();
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.onstart = () => { ring.classList.remove('hidden'); btn.classList.add('bg-blue-600'); };
            
            recognition.onresult = (e) => { 
                const cmd = e.results[0][0].transcript.toLowerCase();
                console.log("Voice:", cmd);

                // --- 1. SPECIFIC PHRASE TRIGGERS (Highest Priority) ---
                if (cmd.includes("leaving") || cmd.includes("going out") || cmd.includes("goodbye")) {
                    console.log("Trigger: Leaving");
                    window.applyGlobalScene('off');
                    return;
                }
                if (cmd.includes("i'm home") || cmd.includes("i am home")) {
                    console.log("Trigger: I'm Home");
                    window.applyGlobalScene('focus');
                    return;
                }
                if (cmd.includes('party') || cmd.includes('disco') || cmd.includes('dance')) {
                    console.log("Trigger: Party");
                    window.togglePartyMode();
                    return;
                }

                // --- 2. ROOM CONTROL (Check for specific rooms FIRST) ---
                const roomSynonyms = {
                    'living': ['living', 'lounge', 'family', 'main room'],
                    'kitchen': ['kitchen', 'cooking', 'dining', 'food'],
                    'bedroom': ['bed', 'bedroom', 'sleep room', 'master'],
                    'office': ['office', 'work', 'desk', 'study', 'computer', 'home office'],
                    'hallway': ['hall', 'corridor', 'entry', 'stairs'],
                    'garden': ['garden', 'yard', 'patio', 'outside', 'balcony']
                };

                let changeMade = false;
                let mentionedRoom = false; 

                Object.values(roomsData).forEach(room => {
                    const roomId = room.id;
                    const synonyms = roomSynonyms[roomId] || [roomId];
                    
                    // Check if command contains any synonym for this room
                    if (synonyms.some(s => cmd.includes(s))) {
                        console.log(`Match: Room ${roomId}`);
                        mentionedRoom = true;
                        
                        const onKeywords = /\b(on|onn|start|enable|activate|light up|brighten|power on)\b/i;
                        const offKeywords = /\b(off|stop|kill|disable|shut down|darken|power off|turn off)\b/i;

                        // Prioritize ON command
                        if (onKeywords.test(cmd)) { 
                            console.log(`Action: ${roomId} ON`);
                            room.isOn = true; changeMade = true; 
                        } 
                        // Else, check for OFF command
                        else if (offKeywords.test(cmd)) {
                            console.log(`Action: ${roomId} OFF`);
                            room.isOn = false; changeMade = true; 
                        }

                        // Colors Logic
                        const colorMap = {
                            'red': '#EF4444', 'blue': '#3B82F6', 'green': '#10B981', 'yellow': '#F59E0B', 
                            'purple': '#A855F7', 'orange': '#F97316', 'pink': '#EC4899', 'cyan': '#06B6D4', 
                            'white': '#FFFFFF', 'warm': '#FFD6AA', 'gold': '#F59E0B', 'magenta': '#DB2777',
                            'warm white': '#FFD6AA', 'milky white': '#FDF4DC', 'cool white': '#F3F4F6', 'soft white': '#FEF3C7',
                            'light yellow': '#FEF08A', 'warm yellow': '#F59E0B', 'lavender': '#E9D5FF', 'violet': '#8B5CF6',
                            'coral': '#FB7185', 'teal': '#14B8A6', 'sky blue': '#7DD3FC', 'lime': '#84CC16'
                        };
                        for (const [cName, hex] of Object.entries(colorMap)) {
                            if (cmd.includes(cName)) { 
                                console.log(`Action: ${roomId} Color ${cName}`);
                                room.color = hex; room.isOn = true; changeMade = true; 
                            }
                        }
                        
                        // BRIGHTNESS LOGIC
                        const percentMatch = cmd.match(/(\d{1,3})%/);
                        if (percentMatch) {
                             let val = parseInt(percentMatch[1]);
                             if (val > 100) val = 100; if (val < 0) val = 0;
                             console.log(`Action: ${roomId} Brightness ${val}%`);
                             room.brightness = val; room.isOn = true; changeMade = true;
                        }
                        else if (cmd.includes('dim') || cmd.includes('low')) { 
                            console.log(`Action: ${roomId} Brightness DIM`);
                            room.brightness = 30; room.isOn = true; changeMade = true; 
                        }
                        else if (cmd.includes('bright') || cmd.includes('max') || cmd.includes('full')) { 
                            console.log(`Action: ${roomId} Brightness MAX`);
                            room.brightness = 100; room.isOn = true; changeMade = true; 
                        }
                    }
                });

                // **CRITICAL**: If we made a room-specific change, save and STOP.
                if (changeMade) {
                    console.log("Change detected, saving and returning.");
                    saveLocalData();
                    return; 
                }

                // --- 3. GLOBAL ON/OFF (Only if no specific room was matched) ---
                // This now catches "turn on the lights", "turn off the light", "light on", "lights off" etc.
                const globalOnRegex = /\b(turn on|power on|activate|lights on|light on)\b/i;
                const globalOffRegex = /\b(turn off|power off|disable|lights off|light off|shut down|dark mode|good night)\b/i;

                // Check for ON, but make sure it's not an "off" command (e.g., "turn on, not off")
                if (globalOnRegex.test(cmd) && !globalOffRegex.test(cmd)) {
                    console.log("Trigger: Global ON");
                    window.applyGlobalScene('focus'); // 'focus' is the default "all on"
                    return;
                }
                
                // Check for OFF
                if (globalOffRegex.test(cmd)) {
                    console.log("Trigger: Global OFF");
                    window.applyGlobalScene('off');
                    return;
                }

                // --- 4. SCENES & MOODS ---
                const sceneKeywords = {
                    'night': ['night', 'sleep', 'bedtime', 'dark', 'goodnight'],
                    'relax': ['relax', 'chill', 'rest', 'cozy'],
                    'focus': ['focus', 'study', 'work', 'bright', 'reading'],
                    'movie': ['movie', 'cinema', 'film', 'theatre'],
                    'ocean': ['ocean', 'sea', 'water', 'blue mood'],
                    'forest': ['forest', 'jungle', 'nature', 'green mood'],
                    'sunset': ['sunset', 'evening', 'dusk', 'orange mood'],
                    'romance': ['romance', 'love', 'date', 'pink mood']
                };

                for (const [id, words] of Object.entries(sceneKeywords)) {
                    if (words.some(w => cmd.includes(w))) {
                        console.log(`Trigger: Scene ${id}`);
                        if (['ocean', 'forest', 'sunset', 'romance'].includes(id)) window.triggerEffect(id);
                        else window.applyGlobalScene(id);
                        return; // Found a scene, so we're done.
                    }
                }

                // --- 5. GLOBAL DIMMING (Last resort) ---
                if (!mentionedRoom && (cmd.includes('dim') || cmd.includes('brightness') || cmd.includes('low light'))) {
                     const percentMatch = cmd.match(/(\d{1,3})%/);
                     let targetBri = 30; // Default dim
                     if (percentMatch) targetBri = parseInt(percentMatch[1]);
                     
                     console.log(`Trigger: Global Dim ${targetBri}%`);
                     Object.values(roomsData).forEach(room => {
                         if (room.isOn) { room.brightness = targetBri; changeMade = true; }
                     });
                     if (changeMade) saveLocalData();
                }

                // If we're here, no command was understood
                console.log("No matching command found.");
            };

            recognition.onend = () => { ring.classList.add('hidden'); btn.classList.remove('bg-blue-600'); };
            recognition.onerror = (e) => { console.error("Speech recognition error:", e.error); ring.classList.add('hidden'); btn.classList.remove('bg-blue-600'); };
            
            recognition.start();
        };

        function initSortable(el) {
            new Sortable(el, {
                animation: 250, delay: 200, delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                onEnd: (evt) => {
                    triggerHaptic();
                    // Reorder logic
                    const items = el.children;
                    const newOrder = {};
                    for(let i=0; i<items.length; i++) {
                        const id = items[i].dataset.id;
                        newOrder[id] = i;
                    }
                    Object.values(roomsData).forEach(room => {
                        room.order = newOrder[room.id];
                    });
                    saveLocalData();
                }
            });
        }
        
        // Helpers
        const triggerHaptic = () => { if (navigator.vibrate) navigator.vibrate(15); };
        function isColorLight(color) { const hex = color.replace('#', ''); const r = parseInt(hex.substr(0, 2), 16); const g = parseInt(hex.substr(2, 2), 16); const b = parseInt(hex.substr(4, 2), 16); return ((r * 299) + (g * 587) + (b * 114)) / 1000 > 155; }
        function hslToHex(h, s, l) { l /= 100; const a = s * Math.min(l, 1 - l) / 100; const f = n => { const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); return Math.round(255 * color).toString(16).padStart(2, '0'); }; return `#${f(0)}${f(8)}${f(4)}`; }
        function kelvinToHex(kelvin) { let temp = kelvin / 100; let r, g, b; if (temp <= 66) { r = 255; g = temp; g = 99.4708025861 * Math.log(g) - 161.1195681661; if (temp <= 19) b = 0; else { b = temp - 10; b = 138.5177312231 * Math.log(b) - 305.0447927307; } } else { r = temp - 60; r = 329.698727446 * Math.pow(r, -0.1332047592); g = temp - 60; g = 288.1221695283 * Math.pow(g, -0.0755148492); b = 255; } const clamp = (x) => Math.max(0, Math.min(255, Math.floor(x))); const toHex = (x) => { const hex = clamp(x).toString(16); return hex.length === 1 ? '0' + hex : hex; }; return `#${toHex(r)}${toHex(g)}${toHex(b)}`; }

        // Start
        initApp();

    </script>
</body>
</html>


